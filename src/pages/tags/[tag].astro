---
// Astro
import { getCollection } from 'astro:content';

// 1. Generate a new path for every collection entry
export async function getStaticPaths() {

   // create a Set so each tag is only listed once
   const allTags = new Set();

   // import tag collection
   const tagCollection = await getCollection('tags');

   // import all non-draft artwork
   const artworkEntries = await getCollection('artwork', ({data}) => !data.draft);

   // sort entries from latest to oldest
   const sortedEntries = artworkEntries.sort((a, b) => Date.parse(b.data.date) - Date.parse(a.data.date));

   // map over each entry to grab its tags and add it to the Set
   sortedEntries.map((entry) => {
      entry.data.tags && entry.data.tags.map((tag) => allTags.add(tag));
   })
   
   return Array.from(allTags).map((tag) => {

      // filter entries by tag from the URL param
      const entriesByTag = sortedEntries.filter((sortedEntry) => sortedEntry.data.tags.find((entryTag) => {

         return entryTag.id === tag.id
      }))

      // get matching tag object from 'tags' collection to use for templates
      const matchingTagObject = tagCollection.filter(({id}) => id === tag.id)[0]

      return {
         params: { 
            tag: tag.id,
         }, 
         props: { 
            entries: entriesByTag,
            tagCollection: tagCollection,
            tag: matchingTagObject
         },
      }
   });
}

// 2. For your template, you can get the entry directly from the prop
const { entries, tag, tagCollection } = Astro.props;
const params = Astro.params;

// import utils
import { titleCase } from "../../utils/textTools.js"

// import layout
import BaseLayout from '../../layouts/BaseLayout.astro';
import ArtworkGridLayout from "../../layouts/ArtworkGridLayout.astro";

// import components
import SectionTitle from "../../components/SectionTitle.jsx";
import ArtTags from "../../components/ArtTags.jsx";
---

<BaseLayout pageTitle={`${titleCase(tag.data.title)}`}>

   <section class="relative">
      <div class="md:top-0 md:sticky md:z-20 flex flex-wrap lg:grid grid-cols-12 items-center justify-between py-2 mb-4 bg-transparent backdrop-blur-md">
         <SectionTitle 
            title={`${titleCase(tag.data.title)}`} 
         />
         <nav class="col-span-9 col-start-4 items-start h-full">
            <ArtTags tags={tagCollection} classes="px-4" listClasses="lg:justify-end" />
         </nav>
      </div>
   
   
      <ArtworkGridLayout artwork={entries} />
   </section>
</BaseLayout>
